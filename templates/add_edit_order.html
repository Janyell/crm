{%extends "base.html"%}

{%block content%}
    <div class="container container_fixed_width">
        <style scoped="">
            .typeahead {
                top: 300px !important;
            }
        </style>
        {% url 'add_claim' as add_claim_url %}
        {% url 'edit_claim' as edit_claim_url %}
        {% url 'add_order' as add_order_url %}
        {% url 'edit_order' as edit_order_url %}
        <a href="
        {% if request.path == add_claim_url and client_id >= 0 %}
            {% url "get_interested_clients" %}{% if request.GET.page and request.GET.length %}?page={{ request.GET.page }}&length={{ request.GET.length }}{% endif %}
        {% elif request.GET.archive %}
            {% url "get_old_orders" %}{% if request.GET.page and request.GET.length %}?page={{ request.GET.page }}&length={{ request.GET.length }}{% endif %}
        {% elif request.GET.history %}
            {% url "get_orders" %}?client-id={{ client_id }}{% if request.GET.page and request.GET.length %}&page={{ request.GET.page }}&length={{ request.GET.length }}{% endif %}
        {% elif request.path == add_order_url and client_id >= 0 %}
            {% url "get_clients" %}{% if request.GET.page and request.GET.length %}?page={{ request.GET.page }}&length={{ request.GET.length }}{% endif %}
        {% elif request.path == add_claim_url or request.path == edit_claim_url %}
            {% url "get_claims" %}{% if request.GET.page and request.GET.length %}?page={{ request.GET.page }}&length={{ request.GET.length }}{% endif %}
        {% else %}
            {% url "get_orders" %}{% if request.GET.page and request.GET.length %}?page={{ request.GET.page }}&length={{ request.GET.length }}{% endif %}
        {% endif %}
        " class="btn">Назад</a>
        <form class="form-horizontal form-add form-add-order" method="post" action="">
            <h2 class="form-add__head">{{ page_title }}</h2>
            <h5 class="form-add__please">Пожалуйста, заполните следующую форму:</h5>
            {% if error == 1 %}
                <div class="text-error">
                    Ошибка в заполнении формы заказа.
                </div>
            {% endif %}
            {% if error == 2 %}
                <div class="text-error">
                    Данное наименование уже есть в списке продукции.
                </div>
            {% endif %}
            {% if error == 3 %}
                <div class="text-error">
                    Вы не добавили ни один продукт в заказ.
                </div>
            {% endif %}
            {% if request.GET.id %}
                <input type="hidden" name="pk" value="{{ request.GET.id }}">
            {% endif %}
            <div class="form-add">
                <div class="control-group form-add__client">
                    <label class="control-label" for="selectClient">
                        Клиент
                        <span class="required-input">*</span>
                    </label>
                    <div class="controls">
                        {{ order_form.client }}
                        {% url 'edit_order' as edit_order_url %}
                        {% if not request.GET.id %}
                            <a class="btn btn-success plus_client" data-toggle="modal" href="#add-client">+</a>
                        {% endif %}
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputAccountNumber">
                        Номер счета
                    </label>
                    <div class="controls">
                        {{ order_form.account_number }}
                    </div>
                </div>
            </div>
            <table class="table table-hover table-bordered" id="add-product-table">
                <thead>
                    <tr>
                        <th>Продукция</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% if order_form.products %}
                        {% for product in order_form.products %}
                            <tr>
                                <td>{{ product.title }}</td>
                                <td>
                                    <span class="btn btn-success plus pull-right" data-productId="{{ product.pk }}">+</span>
                                </td>
                            </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table><!--
            --><div class="select-product-table_wrapper">
                <table class="select-product-table table table-hover table-bordered">
                    <thead>
                        <tr>
                            <th>Выбранная продукция <span class="required-input">*</span></th>
                            <th>Количество</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="select-product-table__plus">
                            <td></td>
                            <td></td>
                            <td><span class="btn btn-success plus pull-right">+</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            {% if order_form.products %}
                <select multiple class="product-select hidden" name="products[]">
                    {% for product in order_form.products %}
                        <option value="{{ product.pk }}"
                            {% if product.count_of_products %}
                                data-number="{{ product.count_of_products }}"
                                selected="selected"
                            {% endif %}
                        >
                            {{ product.title }}
                        </option>
                    {% endfor %}
                </select>
            {% endif %}
            <div class="form-add">
                <div class="control-group">
                    <label class="control-label" for="selectCompany">
                        Компания
                    </label>
                    <div class="controls">
                        {{ order_form.company }}
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputBill">
                        Сумма счета
                    </label>
                    <div class="controls">
                        {{ order_form.bill }}
                    </div>
                </div>
                {% if request.path == add_claim_url or request.path == edit_claim_url %}
                <div class="control-group">
                    <label class="control-label" for="selectStatus">
                        Статус заявки
                    </label>
                    <div class="controls">
                        {{ order_form.bill_status }}
                    </div>
                </div>
                {% else %}
                <div class="control-group">
                    <label class="control-label" for="inputPaymentDate">
                        Дата оплаты
                    </label>
                    <div class="controls">
                        <div id="paymentDate" class="input-append date">
                            {{ order_form.payment_date }}
                            <span class="add-on">
                                <i data-time-icon="icon-time" data-date-icon="icon-calendar"></i>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputReadyDate">
                        Дата готовности
                    </label>
                    <div class="controls">
                        <div id="readyDate" class="input-append date">
                            {{ order_form.ready_date }}
                            <span class="add-on">
                                <i data-time-icon="icon-time" data-date-icon="icon-calendar"></i>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="selectStatus">
                        Статус заказа
                    </label>
                    <div class="controls">
                        {{ order_form.order_status }}
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="selectBillStatus">
                        Статус оплаты
                    </label>
                    <div class="controls">
                        {{ order_form.bill_status }}
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputCity">
                        Доставка (город)
                    </label>
                    <div class="controls">
                        {{ order_form.city }}
                    </div>
                </div>
                {% endif %}
                <div class="control-group">
                    <label class="control-label" for="inputComment">
                        Комментарии
                    </label>
                    <div class="controls">
                        {{ order_form.comment }}
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="selectSource">
                        Источник
                        <span class="required-input">*</span>
                    </label>
                    <div class="controls">
                        {{ order_form.source }}
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputFile">
                        Прикрепленные файлы
                    </label>
                    <div class="controls">
                        <form action="#" method="post" enctype="multipart/form-data">
                            <input name="uploads[]" type="file" multiple />
                            <input type="submit" class="btn" />
                        </form>
                    </div>
                </div>
                <div class="form-add__tips">
                    <div class="form-add-tips__tip">
                        <span class="required-input">*</span> - поля, обязательные для заполнения
                    </div>
                </div>
                <div class="form-add__submits">
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                    <button type="button" class="btn">Очистить</button>
                </div>
            </div>
        </form>
    </div>
    {% if not request.GET.id %}
        <div class="modal hide fade" id="add-client" tabindex="-1" role="dialog" aria-labelledby="ClientLabel" aria-hidden="true">
        {% url 'add_claim' as add_claim_url %}
        {% if request.path == add_claim_url %}
            <form class="form-horizontal form-add_modal form-add-client" method="post" action="{% url "add_client" %}?is_interested=1">
        {% else %}
            <form class="form-horizontal form-add_modal form-add-client" method="post" action="{% url "add_client" %}">
        {% endif %}
                <div class="modal-header">
                    <a class="close" data-dismiss="modal">×</a>
                    <h3 class="form-add__head">{{ modal_title }}</h3>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <div class="form-add__submits">
                        <button type="submit" class="btn btn-primary" name="save-and-add-order" value="save-and-add-order">Сохранить</button>
                        <button type="reset" class="btn">Очистить</button>
                        <button type="button" class="btn" data-dismiss="modal" aria-hidden="true">Закрыть</button>
                    </div>
                </div>
            </form>
        </div>
    {% endif %}
    <script type="text/javascript">
        (function($){
            $(document).ready(function(){
                $("#add-product-table").dataTable({
                    "language": {
                        "url": "{{ STATIC_URL }}language/ru_RU_abbr.txt"
                    },
                    "aoColumnDefs": [
                        { "bSortable": false, "aTargets": [ 1 ] },
                        { "bSearchable": false, "aTargets": [ 1 ] }
                    ]
                });
                {% if request.path != add_claim_url and request.path != edit_claim_url %}
                $('#paymentDate').datetimepicker({
                    format: 'yyyy-MM-dd hh:mm:ss',
                    language: 'ru',
                    pickSeconds: false,
                    weekStart: 1
                });
                $('#readyDate').datetimepicker({
                    format: 'yyyy-MM-dd hh:mm:ss',
                    language: 'ru',
                    pickSeconds: false,
                    weekStart: 1
                });
                {% endif %}
                $('select.product-select option:selected').each(function() {
                    var product_id = $(this).attr('value');
                    $('.plus[data-productId="' + product_id + '"]').click();
                });

                var $select_client = $('#id_client');
                $select_client.attr({
                    'data-live-search': "true",
                    'data-size': "10"
                });
                $select_client.selectpicker();
                var $select_company = $('#id_company');
                $select_company.attr({
                    'data-live-search': "true",
                    'data-size': "10"
                });
                $select_company.selectpicker();

                var url;
                {% if request.path == add_claim_url %}
                    url = "{% url "add_client" %}?is_interested=1";
                {% else %}
                    url = "{% url "add_client" %}";
                {% endif %}
                var $add_client = $('#add-client');
                var $style = $('style');
                $add_client.find(".modal-body").load(url + ' .in-modal', function() {
                    $('#inputPersonPhone').inputmask("mask", {"mask": "(999) 999-9999"});
                    $('#inputOrganizationPhone').inputmask("mask", {"mask": "(999) 999-9999"});
                    $("#inputOrganization").attr({
                        'data-provide': "typeahead",
                        'data-items': "10",
                        'data-source': '[{% for organization in organizations %}"{{ organization }}", {% endfor %} ""]'
                    });
                    $('.form-add-client').on('submit', function(e) {
                        e.preventDefault();
                        $.ajax({
                            type: $(this).attr('method'),
                            url: this.action,
                            data: $(this).serialize(),
                            context: this,
                            success: function(data, status) {
                                var $in_modal = $(data).find(".in-modal").children();
                                if ($in_modal.length == 0) {
                                    $add_client.modal("hide");
                                    $add_client.find(".modal-body").load(url + ' .in-modal', function() {
                                        $('#inputPersonPhone').inputmask("mask", {"mask": "(999) 999-9999"});
                                        $('#inputOrganizationPhone').inputmask("mask", {"mask": "(999) 999-9999"});
                                        $("#inputOrganization").attr({
                                            'data-provide': "typeahead",
                                            'data-items': "10",
                                            'data-source': '[{% for organization in organizations %}"{{ organization }}", {% endfor %} ""]'
                                        });
                                        $style.html(".typeahead { top: 300px !important; }");
                                    });
                                    $('.form-add__client').html($(data).find(".form-add__client").children());
                                    var $select_client = $('#id_client');
                                    $select_client.attr({
                                        'data-live-search': "true",
                                        'data-size': "10"
                                    });
                                    $select_client.selectpicker();
                                }
                                else {
                                    $(".form-add-client .modal-body").html($in_modal);
                                    $('#inputPersonPhone').inputmask("mask", {"mask": "(999) 999-9999"});
                                    $('#inputOrganizationPhone').inputmask("mask", {"mask": "(999) 999-9999"});
                                    $("#inputOrganization").attr({
                                        'data-provide': "typeahead",
                                        'data-items': "10",
                                        'data-source': '[{% for organization in organizations %}"{{ organization }}", {% endfor %} ""]'
                                    });
                                    if ($(".text-error_one").size()) {
                                        $style.html(".typeahead { top: 330px !important; }");
                                    }
                                    else {
                                        if ($(".text-error_two").size()) {
                                            $style.html(".typeahead { top: 350px !important; }");
                                        }
                                    }
                                }
                            }
                        });
                        return false;
                    });
                });
            });
            $(window).load(function () {
                $("#add-product-table_filter").find("input[type='search']").attr("placeholder", "Поиск");
            });
        })(jQuery);
    </script>
{%endblock%}